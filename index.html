<!DOCTYPE html>
<html>
<head>
  <title>Retell Web Call Test</title>
</head>
<body>
  <h1>Retell Web Voice Agent</h1>
  <button id="startBtn">Start Call</button>
  <button id="stopBtn">Stop Call</button>

  <script>
    let ws = null;
    let mediaStream = null;
    let mediaRecorder = null;

    const backendURL = "https://297bbdf4-6140-4a73-a3e5-4d20a8def37f-00-2vbo45asht0ra.pike.replit.dev/create-webcall"; 
    const agentId = "agent_21828e215b6e799c3be2ab5429"; // example: agent-abcd-1234-xxxx-....

    document.getElementById("startBtn").onclick = async () => {
      console.log("Starting call...");

      const session = await fetch(backendURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ agentId })
      }).then(r => r.json());

      console.log("Session response:", session);

      if (!session.websocket_url) {
        alert("Backend error â€” check console");
        return;
      }

      // CONNECT TO RETELL
      ws = new WebSocket(session.websocket_url);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        console.log("WebSocket connected");
        startStreamingAudio();
      };

      ws.onmessage = (msg) => {
        console.log("Incoming data:", msg.data);
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
      };
    };

    async function startStreamingAudio() {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);

      mediaRecorder.ondataavailable = (e) => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          e.data.arrayBuffer().then((buffer) => {
            ws.send(buffer);
          });
        } else {
          console.log("WS closed; skipping audio chunk.");
        }
      };

      mediaRecorder.start(100); // send audio every 100ms
    }

    document.getElementById("stopBtn").onclick = () => {
      if (mediaRecorder) mediaRecorder.stop();
      if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
      if (ws) ws.close();
      console.log("Call ended");
    };
  </script>
</body>
</html>
