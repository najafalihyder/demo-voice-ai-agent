<!DOCTYPE html>
<html>
<body>
<h2>Retell Browser Web Call</h2>

<button id="start">Start Call</button>

<script>
document.getElementById("start").onclick = async () => {

  // 1. Get webcall session from your Replit server
  const session = await fetch("https://297bbdf4-6140-4a73-a3e5-4d20a8def37f-00-2vbo45asht0ra.pike.replit.dev/create-webcall", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      agentId: "agent_21828e215b6e799c3be2ab5429"
    })
  }).then(r => r.json());

  console.log("Session:", session);

  // 2. Connect to Retell realtime audio WebSocket
  const ws = new WebSocket(session.websocket_url);
  ws.binaryType = "arraybuffer";

  // 3. Mic input → Retell
  const audioContext = new AudioContext();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const input = audioContext.createMediaStreamSource(stream);

  const processor = audioContext.createScriptProcessor(4096, 1, 1);
  input.connect(processor);
  processor.connect(audioContext.destination);

  processor.onaudioprocess = (e) => {
    const float = e.inputBuffer.getChannelData(0);
    const pcm = new Int16Array(float.length);
    for (let i = 0; i < float.length; i++)
      pcm[i] = float[i] * 0x7fff;
    ws.send(pcm.buffer);
  };

  // 4. Retell → output speaker
  ws.onmessage = (event) => {
    const pcm = new Int16Array(event.data);
    const buf = audioContext.createBuffer(1, pcm.length, 44100);
    buf.copyToChannel(Float32Array.from(pcm, x => x / 0x7fff), 0);

    const src = audioContext.createBufferSource();
    src.buffer = buf;
    src.connect(audioContext.destination);
    src.start();
  };
};
</script>
</body>
</html>
